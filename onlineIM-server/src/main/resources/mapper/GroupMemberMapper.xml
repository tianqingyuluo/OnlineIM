<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="icu.tianqingyuluo.onlineim.mapper.GroupMemberMapper">
    <!-- 群成员结果映射 -->
    <resultMap id="GroupMemberResultMap" type="icu.tianqingyuluo.onlineim.pojo.dto.response.GroupMemberResponse">
        <result property="role" column="role"/>
        <result property="groupNickname" column="nickname"/>
        <result property="isMuted" column="is_muted"/>
        <result property="muteEndTime" column="mute_end_time"/>
        <result property="joinedAt" column="join_time"/>
        <association property="userInfo" javaType="icu.tianqingyuluo.onlineim.pojo.dto.response.UserBriefResponse">
            <id property="userId" column="user_id"/>
            <result property="username" column="username"/>
            <result property="nickname" column="nickname"/>
            <result property="avatarUrl" column="avatar"/>
        </association>
    </resultMap>

    <!-- 获取群组的所有成员 -->
    <select id="getGroupMembersByGroupID" resultMap="GroupMemberResultMap">
        SELECT
            gm.*,
            u.username,
            u.avatar,
            CASE
                WHEN gm.mute_end_time IS NULL AND gs.mute_type != 1 THEN false
                WHEN gm.mute_end_time > NOW() OR gs.mute_type = 1 THEN true
                ELSE false
                END AS is_muted
        FROM
            group_members gm
                JOIN
            `groups` g ON gm.group_id = g.id
                JOIN
            `users` u ON gm.user_id = u.id
                JOIN
            group_settings gs ON g.id = gs.group_id
        WHERE
            gm.group_id = #{groupId}
    </select>

    <!-- 获取用户加入的所有群组的成员信息 -->
    <select id="getUserJoinedGroups" resultMap="GroupMemberResultMap">
        SELECT gm.* FROM group_members gm 
        JOIN `groups` g ON gm.group_id = g.id
        WHERE gm.user_id = #{userId}
        ORDER BY gm.join_time DESC
    </select>

    <!-- 批量获取群成员 -->
    <select id="batchGetMembersByUserIds" resultMap="GroupMemberResultMap">
        SELECT * FROM group_members 
        WHERE group_id = #{groupId} AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </select>

    <!-- 获取群成员及用户信息 -->
    <select id="getGroupMembersWithUserInfo" resultType="java.util.Map">
        SELECT gm.*, u.username, u.nickname as user_nickname, u.avatar, u.status as user_status
        FROM group_members gm
                 JOIN users u ON gm.user_id = u.id
        WHERE gm.group_id = #{groupId}
        ORDER BY gm.role DESC, gm.join_time
    </select>
</mapper> 